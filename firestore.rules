rules_version = '2';
service cloud.firestore {
  function isBootstrapMaster() {
    return request.auth != null && request.auth.uid == "rpdLNx3X4CZhFvB6O9bvXbFA72y1";
  }

  function isMaster() {
    return isBootstrapMaster()
      || (request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "MASTER");
  }

  match /databases/{database}/documents {

    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && (
          (request.auth.uid == userId
            && request.resource.data.role == "MEMBER"
            && request.resource.data.status == "PENDENTE")
          || isMaster()
        );
      allow update, delete: if isMaster();
    }

    match /stock_items/{docId} {
      allow read: if request.auth != null;
      allow write: if isMaster();
    }

    match /events/{docId} {
      allow read: if request.auth != null;
      allow write: if isMaster();
    }

    match /cash_transactions/{docId} {
      allow read: if request.auth != null;
      allow write: if isMaster();
    }

    match /memberships/{docId} {
      allow read: if request.auth != null;
      allow write: if isMaster();
    }

    match /focus_notes/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if isMaster();
    }

    match /cantigas/{docId} {
      allow read: if request.auth != null;
      allow write: if isMaster();
    }

    match /action_items/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.created_by == request.auth.uid;
      allow update: if request.auth != null
        && (isMaster() || resource.data.created_by == request.auth.uid);
      allow delete: if isMaster();
    }
  }
}
